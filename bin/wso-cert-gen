#!/bin/sh

# WSO Certificate Generator - Webroot method
# Generates SSL certificates using Let's Encrypt certbot with webroot validation

# WSO Paths (hardcoded)
readonly CERT_DIR="/var/lib/wso/letsencrypt"
readonly CERT_LIB_DIR="/var/lib/wso/letsencrypt-lib"
readonly ACME_DIR="/var/lib/wso/acme-challenge"

# Verifica che sia stato fornito almeno un argomento
if [ -z "$1" ]; then
    echo "Uso: $0 domain1.com[,domain2.com,...] [cert-name]"
    echo ""
    echo "Esempi:"
    echo "  $0 example.com"
    echo "  $0 example.com,www.example.com"
    echo "  $0 example.com myapp-staging_example.com"
    exit 1
fi

# Salva la stringa dei domini
domains="$1"

# Certificato personalizzato (opzionale)
cert_name="$2"

# Costruisce la lista di parametri -d per ogni dominio
domain_args=""
IFS=','
for domain in $domains; do
    domain_args="$domain_args -d $domain"
done
unset IFS

# Aggiungi --cert-name se specificato
cert_name_arg=""
if [ -n "$cert_name" ]; then
    cert_name_arg="--cert-name $cert_name"
    echo "Using custom certificate name: $cert_name"
fi

# Esegue il comando docker con tutti i domini
echo "Generating certificate for:$domain_args"
echo ""

sudo docker run -it --rm --name certbot \
  -v "${CERT_DIR}:/etc/letsencrypt" \
  -v "${CERT_LIB_DIR}:/var/lib/letsencrypt" \
  -v "${ACME_DIR}:/srv/webroot" \
  certbot/certbot certonly --webroot -w /srv/webroot$domain_args $cert_name_arg
