#!/bin/sh

# WSO Certificate Generator - Webroot method
# Generates SSL certificates using Let's Encrypt certbot with webroot validation

# WSO Paths (hardcoded)
readonly CERT_DIR="/var/lib/wso/letsencrypt"
readonly CERT_LIB_DIR="/var/lib/wso/letsencrypt-lib"
readonly ACME_DIR="/var/lib/wso/acme-challenge"

# Verifica che sia stato fornito almeno un argomento
if [ -z "$1" ]; then
    echo "Uso: $0 domain1.com[,domain2.com,...] [cert-name]"
    echo ""
    echo "Esempi:"
    echo "  $0 example.com"
    echo "  $0 example.com,www.example.com"
    echo "  $0 example.com myapp-staging_example.com"
    exit 1
fi

# Salva la stringa dei domini
domains="$1"

# Certificato personalizzato (opzionale)
cert_name="$2"

# Costruisce la lista di parametri -d per ogni dominio
domain_args=""
IFS=','
for domain in $domains; do
    domain_args="$domain_args -d $domain"
done
unset IFS

# Aggiungi --cert-name se specificato
cert_name_arg=""
if [ -n "$cert_name" ]; then
    cert_name_arg="--cert-name $cert_name"
    echo "Using custom certificate name: $cert_name"
fi

# =============================================================================
# Configurazione email per Let's Encrypt
# =============================================================================

# Check if email is already stored in WSO config
if [ -f /etc/wso/wso.conf ]; then
    . /etc/wso/wso.conf
fi

if [ -z "${LETSENCRYPT_EMAIL:-}" ]; then
    echo ""
    printf "Email per notifiche Let's Encrypt: "
    read LETSENCRYPT_EMAIL

    if [ -z "$LETSENCRYPT_EMAIL" ]; then
        echo "Errore: Email obbligatoria per Let's Encrypt" >&2
        exit 1
    fi

    # Save email to config
    if grep -q "^LETSENCRYPT_EMAIL=" /etc/wso/wso.conf 2>/dev/null; then
        sudo sed -i "s|^LETSENCRYPT_EMAIL=.*|LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL|" /etc/wso/wso.conf
    else
        echo "LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL" | sudo tee -a /etc/wso/wso.conf >/dev/null
    fi
    echo "âœ“ Email salvata in configurazione"
fi

# Esegue il comando docker con tutti i domini
echo "Generating certificate for:$domain_args"
echo ""

sudo docker run --rm --name certbot \
  -v "${CERT_DIR}:/etc/letsencrypt" \
  -v "${CERT_LIB_DIR}:/var/lib/letsencrypt" \
  -v "${ACME_DIR}:/srv/webroot" \
  certbot/certbot certonly --webroot -w /srv/webroot$domain_args $cert_name_arg \
  --non-interactive \
  --agree-tos \
  --email "$LETSENCRYPT_EMAIL"
