#!/bin/sh

# WSO Certificate Generator - OVH DNS method
# Generates wildcard SSL certificates using Let's Encrypt with OVH DNS-01 challenge
# Credentials are stored as plain files with root-only permissions

# WSO Paths (hardcoded)
readonly CERT_DIR="/var/lib/wso/letsencrypt"
readonly CERT_LIB_DIR="/var/lib/wso/letsencrypt-lib"
readonly SECRETS_DIR="/var/lib/wso/secrets"
readonly OVH_INI_FILE="${SECRETS_DIR}/wso_ovh_ini"

# Verifica che sia stato fornito almeno un argomento
if [ -z "$1" ]; then
    echo "Uso: $0 domain1.com,domain2.com,..."
    echo ""
    echo "Questo script genera certificati SSL usando OVH DNS-01 challenge."
    echo "Supporta wildcard domains (es: *.chdev.eu)"
    echo ""
    echo "Esempi:"
    echo "  $0 chdev.eu,*.chdev.eu"
    echo "  $0 example.com,*.example.com"
    exit 1
fi

# Salva la stringa dei domini
domains="$1"

# Costruisce la lista di parametri -d per ogni dominio
domain_args=""
IFS=','
for domain in $domains; do
    domain_args="$domain_args -d $domain"
done
unset IFS

# =============================================================================
# Gestione credenziali OVH come file semplice
# =============================================================================

# Controlla se le credenziali OVH esistono già
if [ ! -f "$OVH_INI_FILE" ]; then
    echo ""
    echo "==================================================================="
    echo "OVH API Credentials Setup"
    echo "==================================================================="
    echo ""
    echo "Le credenziali OVH non sono configurate."
    echo "Per generare certificati wildcard è necessario configurare l'accesso alle API OVH."
    echo ""
    echo "Ottieni le credenziali da:"
    echo "  - Europa: https://eu.api.ovh.com/createToken/"
    echo "  - Nord America: https://ca.api.ovh.com/createToken/"
    echo ""
    echo "Permessi richiesti:"
    echo "  - GET  /domain/zone/*"
    echo "  - PUT /domain/zone/*"
    echo "  - POST /domain/zone/*"
    echo "  - DELETE /domain/zone/*"
    echo ""

    # Ask for OVH endpoint
    echo "Seleziona l'endpoint OVH:"
    echo "  1) ovh-eu (Europe)"
    echo "  2) ovh-ca (North America)"
    printf "Scelta [1]: "
    read ovh_endpoint_choice
    ovh_endpoint_choice=${ovh_endpoint_choice:-1}

    case "$ovh_endpoint_choice" in
        1)
            OVH_ENDPOINT="ovh-eu"
            ;;
        2)
            OVH_ENDPOINT="ovh-ca"
            ;;
        *)
            echo "Scelta non valida. Uso ovh-eu"
            OVH_ENDPOINT="ovh-eu"
            ;;
    esac

    echo ""
    echo "Endpoint selezionato: $OVH_ENDPOINT"
    echo ""

    # Ask for OVH credentials
    printf "Application Key: "
    read OVH_APP_KEY
    printf "Application Secret: "
    read OVH_APP_SECRET
    printf "Consumer Key: "
    read OVH_CONSUMER_KEY

    # Validate that credentials are not empty
    if [ -z "$OVH_APP_KEY" ] || [ -z "$OVH_APP_SECRET" ] || [ -z "$OVH_CONSUMER_KEY" ]; then
        echo "Errore: Tutte le credenziali sono obbligatorie" >&2
        exit 1
    fi

    # Create ovh.ini content
    OVH_INI_CONTENT="# OVH API credentials for certbot-dns-ovh
dns_ovh_endpoint = $OVH_ENDPOINT
dns_ovh_application_key = $OVH_APP_KEY
dns_ovh_application_secret = $OVH_APP_SECRET
dns_ovh_consumer_key = $OVH_CONSUMER_KEY"

    # Ensure secrets directory exists
    if [ ! -d "$SECRETS_DIR" ]; then
        sudo mkdir -p "$SECRETS_DIR"
        sudo chmod 700 "$SECRETS_DIR"
    fi

    # Save credentials to file with root-only permissions
    echo ""
    echo "Salvando credenziali..."

    if ! echo "$OVH_INI_CONTENT" | sudo tee "$OVH_INI_FILE" > /dev/null; then
        echo "Errore: Impossibile salvare le credenziali" >&2
        exit 1
    fi

    sudo chmod 400 "$OVH_INI_FILE"

    echo "✓ Credenziali salvate in: $OVH_INI_FILE"
    echo ""
fi

# =============================================================================
# Configurazione email per Let's Encrypt
# =============================================================================

# Check if email is already stored in WSO config
if [ -f /etc/wso/wso.conf ]; then
    . /etc/wso/wso.conf
fi

if [ -z "${LETSENCRYPT_EMAIL:-}" ]; then
    echo ""
    printf "Email per notifiche Let's Encrypt: "
    read LETSENCRYPT_EMAIL

    if [ -z "$LETSENCRYPT_EMAIL" ]; then
        echo "Errore: Email obbligatoria per Let's Encrypt" >&2
        exit 1
    fi

    # Save email to config
    if grep -q "^LETSENCRYPT_EMAIL=" /etc/wso/wso.conf 2>/dev/null; then
        sudo sed -i "s|^LETSENCRYPT_EMAIL=.*|LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL|" /etc/wso/wso.conf
    else
        echo "LETSENCRYPT_EMAIL=$LETSENCRYPT_EMAIL" | sudo tee -a /etc/wso/wso.conf >/dev/null
    fi
    echo "✓ Email salvata in configurazione"
fi

# =============================================================================
# Generazione certificato con OVH DNS-01
# =============================================================================

echo "Caricamento credenziali OVH..."

# Copy credentials to temporary file for docker mount
TEMP_OVH_INI="/tmp/ovh-$$.ini"
trap "rm -f $TEMP_OVH_INI" EXIT INT TERM

if ! sudo cp "$OVH_INI_FILE" "$TEMP_OVH_INI" 2>/dev/null; then
    echo "Errore: Impossibile leggere le credenziali OVH" >&2
    echo "Le credenziali potrebbero essere mancanti. Rimuovi $OVH_INI_FILE e riprova." >&2
    exit 1
fi

chmod 600 "$TEMP_OVH_INI"

echo "Generazione certificato per:$domain_args"
echo ""

# Esegui certbot con DNS-01 challenge
sudo docker run --rm --name certbot-ovh \
  -v "${CERT_DIR}:/etc/letsencrypt" \
  -v "${CERT_LIB_DIR}:/var/lib/letsencrypt" \
  -v "${TEMP_OVH_INI}:/secrets/ovh.ini:ro" \
  certbot/dns-ovh certonly \
  --dns-ovh \
  --dns-ovh-credentials /secrets/ovh.ini \
  --non-interactive \
  --agree-tos \
  --email "$LETSENCRYPT_EMAIL" \
  $domain_args

# Cleanup è gestito da trap
