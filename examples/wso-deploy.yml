# WSO Deployment Manifest v2.0
#
# Variables use standard ${VAR} syntax for envsubst interpolation

version: "2.0"

service: myapp-${ENVIRONMENT}

# UID for service data directory (optional, default: 1000)
data_uid: 1000

# Docker stack configuration
stack:
  version: '3.8'
  services:
    webapp:
      image: registry.com/myapp:${ENVIRONMENT}

      deploy:
        replicas: 1
        restart_policy:
          condition: on-failure
          delay: 5s
          max_attempts: 3
        update_config:
          parallelism: 1
          delay: 10s
          failure_action: rollback
          order: start-first
        rollback_config:
          parallelism: 1
          delay: 5s

      environment:
        - API_KEY=${API_KEY}

      volumes:
        - type: bind
          source: /var/lib/wso/data/myapp-${ENVIRONMENT}
          target: /data

      networks:
        - wso-net

  networks:
    wso-net:
      external: true

# Host secrets (systemd-creds, for cron jobs)
secrets:
  bearer_token: "${BEARER_TOKEN}"

# Nginx configuration (auto-generated)
# All nginx settings are optional
force_https: true

# Default domain configuration for service-name.chdev.eu
# Optional: if omitted, uses domains[0] or fails if no domains defined
default_domain:
  container_name: webapp
  port: 8080  # optional, default: 8080

# Custom domains (optional)
# If omitted, only service-name.chdev.eu will be configured
domains:
  - domain: example.com
    cert_name: myapp-staging_example.com  # optional, default: service_domain
    container_name: webapp
    port: 8080  # optional, default: 8080

  - domain: www.example.com
    cert_name: myapp-staging_www.example.com
    container_name: webapp
    # port: 8080  # omitted, uses default

# Cron jobs
cron_jobs:
  - schedule: "0 2 * * *"
    command: "curl -H \"Authorization: Bearer $BEARER_TOKEN\" https://api.example.com/backup"
    secrets:
      BEARER_TOKEN: bearer_token
